WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;const i=this,o=e.WT;let s="Wt-dropzone-hover";const l="Wt-dropzone-indication",r="Wt-dropzone-dragstyle",a=[];let d=!1,c=!0,u=!1,f=!1,p=!1,h=!1,m=null,g=0,y=0;const v=document.createElement("input");v.type="file";v.setAttribute("multiple","multiple");v.style.display="none";t.appendChild(v);const w=document.createElement("input");w.type="file";w.setAttribute("multiple","multiple");w.style.display="none";window.document.body.appendChild(w);t.serverFileInput=w;const F=document.createElement("input");F.type="file";F.setAttribute("multiple","multiple");F.setAttribute("webkitdirectory","true");F.style.display="none";window.document.body.appendChild(F);t.serverDirInput=F;const S=document.createElement("div");S.classList.add("Wt-dropcover");document.body.appendChild(S);this.validFileCheck=function(e,t,n){const i=new FileReader;i.onload=function(){t(!0,n,e)};i.onerror=function(){t(!1,n,e)};i.readAsText(e.file.slice(0,32))};t.setAcceptDrops=function(e){c=e};t.setAcceptDirectories=function(e,t){u=e;f=t};t.setDropIndication=function(e){p=e};t.setDropForward=function(e){h=e};t.ondragenter=function(e){if(c){if(function(e){const t=e.dataTransfer?.items??null,n=null!==t&&Array.prototype.some.call(t,(e=>"file"===e.kind)),i=e.dataTransfer?.types??null,o=null!==i&&i.includes("Files");return n||o}(e)){0===y&&i.setPageHoverStyle();y=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){const t=e.clientX,n=e.clientY;let o=document.elementFromPoint(t,n);0===t&&0===n&&(o=null);if(o!==S)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);y=1}};t.ondragover=function(e){e.preventDefault()};const k=function(e){if((p||h)&&"none"!==o.css(t,"display")&&c){y=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",k);S.ondragover=function(e){e.preventDefault();e.stopPropagation()};S.ondragleave=function(e){c&&1===y&&i.resetDragDrop()};S.ondrop=function(e){e.preventDefault();h?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(c){i.resetDragDrop();0!==e.dataTransfer.files.length&&i.addDataTransferItems(Array.from(e.dataTransfer.items))}};this.addDataTransferItems=async function(n){const i=[],o=n.map((e=>e.webkitGetAsEntry()));for(const e of o){const t=b(e);if(e.isFile){const n=await C(e);t.type=n.type;t.size=n.size;const i=L(n);t.id=i.id}else if(e.isDirectory){if(!u){console.warn("directory drop not enabled, ignoring entry",e);continue}t.contents=[];await D(e,t,f)}i.push(t)}if(0!==i.length){console.log("All newKeys: ",i);e.emit(t,"dropsignal",JSON.stringify(i))}};this.addFiles=function(n){const i=[];for(const e of n){const t=L(e),n={};n.id=t.id;n.filename=t.file.name;n.path=t.file.name;n.type=t.file.type;n.size=t.file.size;i.push(n)}e.emit(t,"dropsignal",JSON.stringify(i))};async function D(e,t,n){const i=await function(e){return new Promise((t=>{e.createReader().readEntries((function(e){t(e)}))}))}(e);for(let e=0;e<i.length;e++){const o=i[e],s=b(o);if(o.isFile){const e=await C(o);s.type=e.type;s.size=e.size;const t=L(e);s.id=t.id}else if(o.isDirectory){s.contents=[];n&&await D(o,s,n)}t.contents.push(s)}}function b(e){const t={};t.path=e.fullPath;t.filename=e.name;return t}function C(e){return new Promise((t=>{e.file((function(e){t(e)}))}))}function L(e){const t=new Object;t.id=Math.floor(Math.random()*Math.pow(2,31));t.file=e;a.push(t);return t}t.addEventListener("click",(function(){if(c){v.value="";v.click()}}));t.markForSending=function(e){for(const t of e){const e=t.id;for(const t of a)if(t.id===e){t.ready=!0;break}}d||a.length>0&&a[0].ready&&i.requestSend()};this.requestSend=function(){if(a[0].skip)i.uploadFinished(null);else{d=!0;e.emit(t,"requestsend",a[0].id)}};t.send=function(o,s){const l=a[0];if(l.file.size>n){e.emit(t,"filetoolarge",l.file.size);i.uploadFinished(null)}else if("boolean"==typeof t.wtUseCustomSend){if("function"!=typeof t.wtCustomSend)console.log("Warning: wtUseCustomSend is set, but wtCustomSend is not properly defined as a function. Falling back to the default upload mechanism");else if(t.wtUseCustomSend){i.validFileCheck(l,t.wtCustomSend,o);return}}else{const e=null!==m&&s?i.workerSend:i.actualSend;i.validFileCheck(l,e,o)}};this.actualSend=function(e,t,n){if(!e){i.uploadFinished(null);return}const o=new XMLHttpRequest;o.addEventListener("load",i.uploadFinished);o.addEventListener("error",i.uploadFinished);o.addEventListener("abort",i.uploadFinished);o.addEventListener("timeout",i.uploadFinished);o.open("POST",t);a[0].request=o;const s=new FormData;s.append("file-id",a[0].id);s.append("data",a[0].file);o.send(s)};this.workerSend=function(e,t,n){if(e){m.upload=a[0];m.postMessage({cmd:"send",url:t,upload:a[0],chunksize:g})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",a[0].id);a.splice(0,1);if(a[0]&&a[0].ready)i.requestSend();else{d=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(a[0]&&a[0].id===e){a[0].skip=!0;a[0].request?a[0].request.abort():m&&m.upload===a[0]&&m.postMessage({cmd:"cancel",upload:a[0]})}else for(let t=1;t<a.length;t++)a[t].id===e&&(a[t].skip=!0)};const W=function(){c&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};v.onchange=W;w.onchange=W;F.onchange=function(){if(!c)return;if(null===this.files||0===this.files.length)return;const n=[];for(let e=0;e<this.files.length;e++)E(n,this.files[e]);e.emit(t,"dropsignal",JSON.stringify(n))};function E(e,t){const n=t.webkitRelativePath,i=n.split("/");if(!f&&i.length>2)return;let o=null,s="";for(let t=0;t<i.length-1;t++){const n=i[t];s+="/"+n;const l=e.find((e=>e.path===s));if(l)o=l;else{const t={};t.path=s;t.filename=n;t.contents=[];null===o?e.push(t):o.contents.push(t);o=t}e=o.contents}const l={},r=L(t);l.id=r.id;l.path="/"+n;l.filename=t.name;l.type=t.type;l.size=t.size;o.contents.push(l)}this.setPageHoverStyle=function(){if(p||h){S.classList.add(r);t.classList.add(r);p&&t.classList.add(l)}};this.setWidgetHoverStyle=function(e){t.classList.toggle(s,e)};this.resetDragDrop=function(){t.classList.remove(l);t.classList.remove(r);S.classList.remove(r);i.setWidgetHoverStyle(!1);y=0};t.configureHoverClass=function(e){s=e};t.setFilters=function(e){v.setAttribute("accept",e);w.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){m=new Worker(n);m.onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};m.postMessage({cmd:"check"})}else m=null};t.setChunkSize=function(e){g=e};t.destructor=function(){document.body.removeEventListener("dragenter",k);document.body.removeChild(S)}}));