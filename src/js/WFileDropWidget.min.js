WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;const i=this,o=e.WT;let s="Wt-dropzone-hover";const d="Wt-dropzone-indication",l="Wt-dropzone-dragstyle",r=[];let a=!1,u=!0,c=!1,f=!1,p=null,h=0,m=0;const g=document.createElement("input");g.type="file";g.setAttribute("multiple","multiple");g.style.display="none";t.appendChild(g);const v=document.createElement("div");v.classList.add("Wt-dropcover");document.body.appendChild(v);this.validFileCheck=function(e,t,n){const i=new FileReader;i.onload=function(){t(!0,n,e)};i.onerror=function(){t(!1,n,e)};i.readAsText(e.file.slice(0,32))};t.setAcceptDrops=function(e){u=e};t.setDropIndication=function(e){c=e};t.setDropForward=function(e){f=e};t.ondragenter=function(e){if(u){if(function(e){const t=e.dataTransfer?.items??null,n=null!==t&&Array.prototype.some.call(t,(e=>"file"===e.kind)),i=e.dataTransfer?.types??null,o=null!==i&&i.includes("Files");return n||o}(e)){0===m&&i.setPageHoverStyle();m=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){const t=e.clientX,n=e.clientY;let o=document.elementFromPoint(t,n);0===t&&0===n&&(o=null);if(o!==v)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);m=1}};t.ondragover=function(e){e.preventDefault()};const y=function(e){if((c||f)&&"none"!==o.css(t,"display")&&u){m=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",y);v.ondragover=function(e){e.preventDefault();e.stopPropagation()};v.ondragleave=function(e){u&&1===m&&i.resetDragDrop()};v.ondrop=function(e){e.preventDefault();f?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(u){i.resetDragDrop();0!==e.dataTransfer.files.length&&i.addFiles(e.dataTransfer.files)}};this.addFiles=function(n){const i=[];for(const e of n){const t=new Object;t.id=Math.floor(Math.random()*Math.pow(2,31));t.file=e;r.push(t);const n={};n.id=t.id;n.filename=t.file.name;n.type=t.file.type;n.size=t.file.size;i.push(n)}e.emit(t,"dropsignal",JSON.stringify(i))};t.addEventListener("click",(function(){if(u){g.value="";g.click()}}));t.markForSending=function(e){for(const t of e){const e=t.id;for(const t of r)if(t.id===e){t.ready=!0;break}}a||r[0].ready&&i.requestSend()};this.requestSend=function(){if(r[0].skip)i.uploadFinished(null);else{a=!0;e.emit(t,"requestsend",r[0].id)}};t.send=function(o,s){const d=r[0];if(d.file.size>n){e.emit(t,"filetoolarge",d.file.size);i.uploadFinished(null)}else if("boolean"==typeof t.wtUseCustomSend){if("function"!=typeof t.wtCustomSend)console.log("Warning: wtUseCustomSend is set, but wtCustomSend is not properly defined as a function. Falling back to the default upload mechanism");else if(t.wtUseCustomSend){i.validFileCheck(d,t.wtCustomSend,o);return}}else{const e=null!==p&&s?i.workerSend:i.actualSend;i.validFileCheck(d,e,o)}};this.actualSend=function(e,t,n){if(!e){i.uploadFinished(null);return}const o=new XMLHttpRequest;o.addEventListener("load",i.uploadFinished);o.addEventListener("error",i.uploadFinished);o.addEventListener("abort",i.uploadFinished);o.addEventListener("timeout",i.uploadFinished);o.open("POST",t);r[0].request=o;const s=new FormData;s.append("file-id",r[0].id);s.append("data",r[0].file);o.send(s)};this.workerSend=function(e,t,n){if(e){p.upload=r[0];p.postMessage({cmd:"send",url:t,upload:r[0],chunksize:h})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",r[0].id);r.splice(0,1);if(r[0]&&r[0].ready)i.requestSend();else{a=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(r[0]&&r[0].id===e){r[0].skip=!0;r[0].request?r[0].request.abort():p&&p.upload===r[0]&&p.postMessage({cmd:"cancel",upload:r[0]})}else for(let t=1;t<r.length;t++)r[t].id===e&&(r[t].skip=!0)};g.onchange=function(){u&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};this.setPageHoverStyle=function(){if(c||f){v.classList.add(l);t.classList.add(l);c&&t.classList.add(d)}};this.setWidgetHoverStyle=function(e){t.classList.toggle(s,e)};this.resetDragDrop=function(){t.classList.remove(d);t.classList.remove(l);v.classList.remove(l);i.setWidgetHoverStyle(!1);m=0};t.configureHoverClass=function(e){s=e};t.setFilters=function(e){g.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){p=new Worker(n);p.onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};p.postMessage({cmd:"check"})}else p=null};t.setChunkSize=function(e){h=e};t.destructor=function(){document.body.removeEventListener("dragenter",y);document.body.removeChild(v)}}));